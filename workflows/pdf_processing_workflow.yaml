main:
  params: [pdf_path]
  
  steps:
    # Set default values
    - set_defaults:
        assign:
          - bucket_name: "book-qc-cf-pdf-storage"
          - project_id: "book-qc-cf"
    
    # Step 1: Analyze PDF
    - analyze_pdf:
        call: http.post
        args:
          url: "https://pdf-processor-3b2xvx4raq-uc.a.run.app/analyze"  # Will be updated after deployment
          headers:
            Content-Type: "application/json"
          body:
            pdf_path: "${pdf_path}"
            bucket_name: "${bucket_name}"
        result: analysis_result
    
    # Step 2: Check if analysis was successful
    - check_analysis:
        switch:
          - condition: ${analysis_result.body.status == "success"}
            next: split_pdf
          - condition: true
            next: handle_analysis_error
    
    # Step 3: Split PDF based on analysis
    - split_pdf:
        call: http.post
        args:
          url: "https://pdf-processor-3b2xvx4raq-uc.a.run.app/split"  # Will be updated after deployment
          headers:
            Content-Type: "application/json"
          body:
            pdf_path: "${pdf_path}"
            analysis_path: "${analysis_result.body.analysis_gcs_path}"
            bucket_name: "${bucket_name}"
        result: split_result
    
    # Step 4: Check if splitting was successful
    - check_split:
        switch:
          - condition: ${split_result.body.status == "success"}
            next: return_success
          - condition: true
            next: handle_split_error
    
    # Step 5: Return success result
    - return_success:
        return:
          status: "success"
          message: "PDF processing completed successfully"
          analysis_result: ${analysis_result}
          split_result: ${split_result}
          total_files: ${split_result.body.total_files}
    
    # Step 6: Handle analysis error
    - handle_analysis_error:
        return:
          status: "error"
          message: "PDF analysis failed"
          error: ${analysis_result}
    
    # Step 7: Handle split error
    - handle_split_error:
        return:
          status: "error"
          message: "PDF splitting failed"
          error: ${split_result}