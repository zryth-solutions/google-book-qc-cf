main:
  params: [pdf_path]
  
  steps:
    # Set default values
    - set_defaults:
        assign:
          - bucket_name: "book-qc-cf-pdf-storage"
          - project_id: "book-qc-cf"
          - region: "us-central1"
    
    # Execute complete PDF processing job (analyze + split in one command)
    - process_pdf_job:
        call: googleapis.run.v2.projects.locations.jobs.run
        args:
          name: "projects/${project_id}/locations/${region}/jobs/pdf-processor-job"
          body:
            overrides:
              containerOverrides:
              - args: 
                - "process"
                - "--pdf-path"
                - "${pdf_path}"
                - "--bucket-name"
                - "${bucket_name}"
                env:
                - name: PROJECT_ID
                  value: "${project_id}"
                - name: BUCKET_NAME
                  value: "${bucket_name}"
                - name: REGION
                  value: "${region}"
        result: process_job
    
    # Wait for job completion
    - wait_for_completion:
        call: sys.sleep
        args:
          seconds: 30
    
    # Check job execution status
    - get_execution_status:
        call: googleapis.run.v2.projects.locations.jobs.executions.get
        args:
          name: ${process_job.name}
        result: execution_status
    
    # Return success result
    - return_success:
        return:
          status: "success"
          message: "PDF processing completed successfully using Cloud Run Jobs"
          pdf_path: ${pdf_path}
          job_execution: ${process_job}
          execution_status: ${execution_status}
          bucket_name: ${bucket_name}