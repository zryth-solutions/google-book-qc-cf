main:
  params: [pdf_path]
  
  steps:
    # Set default values
    - set_defaults:
        assign:
          - bucket_name: "book-qc-cf-pdf-storage"
          - project_id: "book-qc-cf"
          - region: "us-central1"
    
    # Execute complete PDF processing job using HTTP connector
    - process_pdf_job:
        call: http.post
        args:
          url: ${"https://run.googleapis.com/v2/projects/" + project_id + "/locations/" + region + "/jobs/pdf-processor-job:run"}
          auth:
            type: OAuth2
          body:
            overrides:
              containerOverrides:
                - args: 
                    - "process"
                    - "--pdf-path"
                    - ${pdf_path.pdf_path}
                    - "--bucket-name"
                    - ${bucket_name}
                  env:
                    - name: PROJECT_ID
                      value: ${project_id}
                    - name: BUCKET_NAME
                      value: ${bucket_name}
                    - name: REGION
                      value: ${region}
        result: process_job
    
    # Wait for job completion
    - wait_for_completion:
        call: sys.sleep
        args:
          seconds: 30
    
    # Return success result
    - return_success:
        return:
          status: "success"
          message: "PDF processing completed successfully using Cloud Run Jobs"
          pdf_path: ${pdf_path}
          job_execution: ${process_job}
          bucket_name: ${bucket_name}