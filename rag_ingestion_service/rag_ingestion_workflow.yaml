main:
  params: [input_data]
  
  steps:
    # Set default values and extract parameters
    - set_defaults:
        assign:
          - bucket_name: "llm-books"
          - project_id: "book-qc-cf"
          - region: "us-central1"
          - update_existing: true
          - pdf_path: ${input_data.pdf_path}
          - book_name: ${input_data.book_name}
          - chapter: null
    
    # Execute RAG ingestion job using HTTP connector
    - process_rag_job:
        call: http.post
        args:
          url: ${"https://run.googleapis.com/v2/projects/" + project_id + "/locations/" + region + "/jobs/rag-ingestion-job:run"}
          auth:
            type: OAuth2
          body:
            overrides:
              containerOverrides:
                - args: 
                    - "python"
                    - "cli_main.py"
                    - "process"
                    - "--pdf-path"
                    - ${pdf_path}
                    - "--book-name"
                    - ${book_name}
                    - "--update-existing"
                  env:
                    - name: PROJECT_ID
                      value: ${project_id}
                    - name: BUCKET_NAME
                      value: ${bucket_name}
                    - name: REGION
                      value: ${region}
        result: process_job
    
    # Wait for job completion
    - wait_for_completion:
        call: sys.sleep
        args:
          seconds: 60
    
    # Return success result
    - return_success:
        return:
          status: "success"
          message: "RAG ingestion and vector storage completed successfully"
          pdf_path: ${pdf_path}
          book_name: ${book_name}
          chapter: ${chapter}
          job_execution: ${process_job}
          bucket_name: ${bucket_name}