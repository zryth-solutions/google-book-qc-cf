main:
  params: [input]
  
  steps:
    # Set default values and extract parameters
    - set_defaults:
        assign:
          - bucket_name: "book-qc-cf-pdf-storage"
          - project_id: "book-qc-cf"
          - region: "us-central1"
          - pdf_path: ${input.input.pdf_path}
          - extraction_type: "questions"
          - subject: "computer_applications"
    
    # Step 1: Extract questions using Cloud Run Job
    - extract_questions_job:
        call: googleapis.run.v1.namespaces.jobs.run
        args:
          name: "projects/${project_id}/locations/${region}/jobs/book-extractor-job"
          body:
            spec:
              template:
                spec:
                  template:
                    spec:
                      containers:
                      - args: 
                        - "extract-questions"
                        - "--pdf-path"
                        - "${pdf_path}"
                        - "--subject"
                        - "${subject}"
                        env:
                        - name: GOOGLE_CLOUD_PROJECT
                          value: "${project_id}"
                        - name: BUCKET_NAME
                          value: "${bucket_name}"
                        - name: VERTEX_AI_LOCATION
                          value: "${region}"
        result: questions_job
    
    # Step 2: Wait for questions job completion
    - wait_for_questions:
        call: sys.sleep
        args:
          seconds: 30
    
    # Step 3: Extract answers using Cloud Run Job  
    - extract_answers_job:
        call: googleapis.run.v1.namespaces.jobs.run
        args:
          name: "projects/${project_id}/locations/${region}/jobs/book-extractor-job"
          body:
            spec:
              template:
                spec:
                  template:
                    spec:
                      containers:
                      - args: 
                        - "extract-answers"
                        - "--pdf-path"
                        - "${pdf_path}"
                        - "--subject"
                        - "${subject}"
                        env:
                        - name: GOOGLE_CLOUD_PROJECT
                          value: "${project_id}"
                        - name: BUCKET_NAME
                          value: "${bucket_name}"
                        - name: VERTEX_AI_LOCATION
                          value: "${region}"
        result: answers_job
    
    # Step 4: Wait for answers job completion
    - wait_for_answers:
        call: sys.sleep
        args:
          seconds: 30
    
    # Step 5: Return success result
    - return_success:
        return:
          status: "success"
          message: "Book extraction completed successfully using Cloud Run Jobs"
          pdf_path: ${pdf_path}
          subject: ${subject}
          questions_job: ${questions_job}
          answers_job: ${answers_job}
          bucket_name: ${bucket_name}

# Workflow for processing both question paper and answer key
process_both:
  params: [input]
  
  steps:
    # Set default values and extract parameters
    - set_defaults:
        assign:
          - bucket_name: "book-qc-cf-pdf-storage"
          - project_id: "book-qc-cf"
          - region: "us-central1"
          - question_pdf_path: ${input.input.question_pdf_path}
          - answer_pdf_path: ${input.input.answer_pdf_path}
          - subject: "computer_applications"
    
    # Step 1: Extract questions from question paper
    - extract_questions_job:
        call: googleapis.run.v1.namespaces.jobs.run
        args:
          name: "projects/${project_id}/locations/${region}/jobs/book-extractor-job"
          body:
            spec:
              template:
                spec:
                  template:
                    spec:
                      containers:
                      - args: 
                        - "extract-questions"
                        - "--pdf-path"
                        - "${question_pdf_path}"
                        - "--subject"
                        - "${subject}"
                        env:
                        - name: GOOGLE_CLOUD_PROJECT
                          value: "${project_id}"
                        - name: BUCKET_NAME
                          value: "${bucket_name}"
                        - name: VERTEX_AI_LOCATION
                          value: "${region}"
        result: questions_job
    
    # Step 2: Extract answers from answer key (parallel execution)
    - extract_answers_job:
        call: googleapis.run.v1.namespaces.jobs.run
        args:
          name: "projects/${project_id}/locations/${region}/jobs/book-extractor-job"
          body:
            spec:
              template:
                spec:
                  template:
                    spec:
                      containers:
                      - args: 
                        - "extract-answers"
                        - "--pdf-path"
                        - "${answer_pdf_path}"
                        - "--subject"
                        - "${subject}"
                        env:
                        - name: GOOGLE_CLOUD_PROJECT
                          value: "${project_id}"
                        - name: BUCKET_NAME
                          value: "${bucket_name}"
                        - name: VERTEX_AI_LOCATION
                          value: "${region}"
        result: answers_job
    
    # Step 3: Wait for both jobs completion
    - wait_for_completion:
        call: sys.sleep
        args:
          seconds: 45
    
    # Step 4: Return success result
    - return_success:
        return:
          status: "success"
          message: "Both question and answer extraction completed successfully using Cloud Run Jobs"
          question_pdf_path: ${question_pdf_path}
          answer_pdf_path: ${answer_pdf_path}
          subject: ${subject}
          questions_job: ${questions_job}
          answers_job: ${answers_job}
          bucket_name: ${bucket_name}