main:
  params: [folder_path, subject, extraction_type]
  
  steps:
    # Set default values
    - set_defaults:
        assign:
          - bucket_name: "book-qc-cf-pdf-storage"
          - project_id: "book-qc-cf"
          - region: "us-central1"
    
    # Validate extraction type
    - validate_extraction_type:
        switch:
          - condition: ${extraction_type == "questions"}
            next: extract_questions_only
          - condition: ${extraction_type == "answers"}
            next: extract_answers_only
          - condition: ${extraction_type == "both"}
            next: extract_both_types
        next: invalid_extraction_type
    
    # Handle invalid extraction type
    - invalid_extraction_type:
        return:
          status: "error"
          message: "Invalid extraction_type. Must be 'questions', 'answers', or 'both'"
    
    # Extract questions only
    - extract_questions_only:
        call: googleapis.run.v2.projects.locations.jobs.run
        args:
          name: "projects/${project_id}/locations/${region}/jobs/book-extractor-job"
          body:
            overrides:
              containerOverrides:
              - args: 
                - "extract-folder-questions"
                - "--folder-path"
                - "${folder_path}"
                - "--subject"
                - "${subject}"
                env:
                - name: GOOGLE_CLOUD_PROJECT
                  value: "${project_id}"
                - name: BUCKET_NAME
                  value: "${bucket_name}"
                - name: VERTEX_AI_LOCATION
                  value: "${region}"
        result: questions_job
        next: wait_and_return
    
    # Extract answers only
    - extract_answers_only:
        call: googleapis.run.v2.projects.locations.jobs.run
        args:
          name: "projects/${project_id}/locations/${region}/jobs/book-extractor-job"
          body:
            overrides:
              containerOverrides:
              - args: 
                - "extract-folder-answers"
                - "--folder-path"
                - "${folder_path}"
                - "--subject"
                - "${subject}"
                env:
                - name: GOOGLE_CLOUD_PROJECT
                  value: "${project_id}"
                - name: BUCKET_NAME
                  value: "${bucket_name}"
                - name: VERTEX_AI_LOCATION
                  value: "${region}"
        result: answers_job
        next: wait_and_return
    
    # Extract both questions and answers
    - extract_both_types:
        steps:
          - extract_questions_first:
              call: googleapis.run.v2.projects.locations.jobs.run
              args:
                name: "projects/${project_id}/locations/${region}/jobs/book-extractor-job"
                body:
                  overrides:
                    containerOverrides:
                    - args: 
                      - "extract-folder-questions"
                      - "--folder-path"
                      - "${folder_path}"
                      - "--subject"
                      - "${subject}"
                      env:
                      - name: GOOGLE_CLOUD_PROJECT
                        value: "${project_id}"
                      - name: BUCKET_NAME
                        value: "${bucket_name}"
                      - name: VERTEX_AI_LOCATION
                        value: "${region}"
              result: questions_job
          
          - wait_between_jobs:
              call: sys.sleep
              args:
                seconds: 60
          
          - extract_answers_second:
              call: googleapis.run.v2.projects.locations.jobs.run
              args:
                name: "projects/${project_id}/locations/${region}/jobs/book-extractor-job"
                body:
                  overrides:
                    containerOverrides:
                    - args: 
                      - "extract-folder-answers"
                      - "--folder-path"
                      - "${folder_path}"
                      - "--subject"
                      - "${subject}"
                      env:
                      - name: GOOGLE_CLOUD_PROJECT
                        value: "${project_id}"
                      - name: BUCKET_NAME
                        value: "${bucket_name}"
                      - name: VERTEX_AI_LOCATION
                        value: "${region}"
              result: answers_job
        next: wait_and_return
    
    # Wait for completion and return result
    - wait_and_return:
        call: sys.sleep
        args:
          seconds: 30
        next: return_success
    
    # Return success result
    - return_success:
        return:
          status: "success"
          message: "Folder extraction completed successfully"
          folder_path: ${folder_path}
          subject: ${subject}
          extraction_type: ${extraction_type}
          questions_job: ${default(map.get(sys.get_env(), "questions_job"), null)}
          answers_job: ${default(map.get(sys.get_env(), "answers_job"), null)}
          bucket_name: ${bucket_name}