main:
  params: [input]
  
  steps:
    # Set default values and extract parameters
    - set_defaults:
        assign:
          - bucket_name: "book-qc-cf-pdf-storage"
          - project_id: "book-qc-cf" 
          - region: "us-central1"
          - folder_path: ${input.input.folder_path}
          - extraction_type: ${default(input.input.extraction_type, "questions")}
          - subject: ${default(input.input.subject, "computer_applications")}
    
    # Determine which extraction type to perform
    - check_extraction_type:
        switch:
          - condition: ${extraction_type == "questions"}
            next: extract_folder_questions
          - condition: ${extraction_type == "answers"}
            next: extract_folder_answers
          - condition: ${extraction_type == "both"}
            next: extract_both_types
          - condition: true
            next: invalid_extraction_type
    
    # Invalid extraction type error
    - invalid_extraction_type:
        return:
          status: "error"
          message: "Invalid extraction type. Must be 'questions', 'answers', or 'both'"
          extraction_type: ${extraction_type}
    
    # Extract questions from all PDFs in folder
    - extract_folder_questions:
        call: googleapis.run.v1.namespaces.jobs.run
        args:
          name: "projects/${project_id}/locations/${region}/jobs/book-extractor-job"
          body:
            spec:
              template:
                spec:
                  template:
                    spec:
                      containers:
                      - args: 
                        - "extract-folder-questions"
                        - "--folder-path"
                        - "${folder_path}"
                        - "--subject"
                        - "${subject}"
                        env:
                        - name: GOOGLE_CLOUD_PROJECT
                          value: "${project_id}"
                        - name: BUCKET_NAME
                          value: "${bucket_name}"
                        - name: VERTEX_AI_LOCATION
                          value: "${region}"
        result: questions_job
        next: wait_and_return_questions
    
    # Extract answers from all PDFs in folder
    - extract_folder_answers:
        call: googleapis.run.v1.namespaces.jobs.run
        args:
          name: "projects/${project_id}/locations/${region}/jobs/book-extractor-job"
          body:
            spec:
              template:
                spec:
                  template:
                    spec:
                      containers:
                      - args: 
                        - "extract-folder-answers"
                        - "--folder-path"
                        - "${folder_path}"
                        - "--subject"
                        - "${subject}"
                        env:
                        - name: GOOGLE_CLOUD_PROJECT
                          value: "${project_id}"
                        - name: BUCKET_NAME
                          value: "${bucket_name}"
                        - name: VERTEX_AI_LOCATION
                          value: "${region}"
        result: answers_job
        next: wait_and_return_answers
    
    # Extract both questions and answers (sequential processing)
    - extract_both_types:
        steps:
          - extract_questions_first:
              call: googleapis.run.v1.namespaces.jobs.run
              args:
                name: "projects/${project_id}/locations/${region}/jobs/book-extractor-job"
                body:
                  spec:
                    template:
                      spec:
                        template:
                          spec:
                            containers:
                            - args: 
                              - "extract-folder-questions"
                              - "--folder-path"
                              - "${folder_path}"
                              - "--subject"
                              - "${subject}"
                              env:
                              - name: GOOGLE_CLOUD_PROJECT
                                value: "${project_id}"
                              - name: BUCKET_NAME
                                value: "${bucket_name}"
                              - name: VERTEX_AI_LOCATION
                                value: "${region}"
              result: questions_job
          
          - wait_between_jobs:
              call: sys.sleep
              args:
                seconds: 60
          
          - extract_answers_second:
              call: googleapis.run.v1.namespaces.jobs.run
              args:
                name: "projects/${project_id}/locations/${region}/jobs/book-extractor-job"
                body:
                  spec:
                    template:
                      spec:
                        template:
                          spec:
                            containers:
                            - args: 
                              - "extract-folder-answers"
                              - "--folder-path"
                              - "${folder_path}"
                              - "--subject"
                              - "${subject}"
                              env:
                              - name: GOOGLE_CLOUD_PROJECT
                                value: "${project_id}"
                              - name: BUCKET_NAME
                                value: "${bucket_name}"
                              - name: VERTEX_AI_LOCATION
                                value: "${region}"
              result: answers_job
        next: wait_and_return_both
    
    # Wait and return results for questions only
    - wait_and_return_questions:
        call: sys.sleep
        args:
          seconds: 120  # Longer wait for folder processing
        next: return_questions_success
    
    - return_questions_success:
        return:
          status: "success"
          message: "Folder questions extraction completed successfully using Cloud Run Jobs"
          extraction_type: "questions"
          folder_path: ${folder_path}
          subject: ${subject}
          job_result: ${questions_job}
          bucket_name: ${bucket_name}
    
    # Wait and return results for answers only
    - wait_and_return_answers:
        call: sys.sleep
        args:
          seconds: 120  # Longer wait for folder processing
        next: return_answers_success
    
    - return_answers_success:
        return:
          status: "success"
          message: "Folder answers extraction completed successfully using Cloud Run Jobs"
          extraction_type: "answers"
          folder_path: ${folder_path}
          subject: ${subject}
          job_result: ${answers_job}
          bucket_name: ${bucket_name}
    
    # Wait and return results for both
    - wait_and_return_both:
        call: sys.sleep
        args:
          seconds: 180  # Even longer wait for both extractions
        next: return_both_success
    
    - return_both_success:
        return:
          status: "success"
          message: "Folder extraction for both questions and answers completed successfully using Cloud Run Jobs"
          extraction_type: "both"
          folder_path: ${folder_path}
          subject: ${subject}
          questions_job: ${questions_job}
          answers_job: ${answers_job}
          bucket_name: ${bucket_name}